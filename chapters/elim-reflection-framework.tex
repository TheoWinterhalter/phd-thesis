% \setchapterpreamble[u]{\margintoc}
\chapter{Framework}
\labch{elim-reflection-framework}

Now that the problem is stated, I will clearly define what the type theories
I will use as source and target. This is a bit redundant with \nrefch{flavours}
but I think it's worthwhile to make it clear what the translation is operating
on.

\section{Syntax(es)}

To make things simple I will consider the syntax of \acrshort{ITT} and
\acrshort{WTT} as extensions of the syntax of \acrshort{ETT}.
Actually, \acrshort{WTT} will also extend \acrshort{ITT}.

\subsection{Syntax of \acrshort{ETT}}

First, comes the syntax of \acrshort{ETT}.

\[
  \begin{array}{l@{~\,}r@{~\,}l}
    s &\in& \cS \\
    T,A,B,t,u,v &\bnf& x \bnfor \lam{x:A}{B} t \bnfor \app{t}{x:A}{B}{u} \\
    &\bnfor& \pair{x:A}{B}{u}{v} \bnfor \pio{x:A}{B}{p} \bnfor \pit{x:A}{B}{p} \\
    &\bnfor& \refl{A} u \bnfor \J{A}{u}{x.e.P}{w}{v}{p} \\
    % &\bnfor& \funext{x:A}{B}{f}{g}{e} \bnfor \uip{A}{u}{v}{p}{q} \\
    &\bnfor& \ax{n} \\
    &\bnfor& s \bnfor \Prod{x:A} B \bnfor \Sum{x:A} B \bnfor \Eq{A}{u}{v} \\
    \Ga, \D &\bnf& \ctxempty \bnfor \Ga, x:A \\
    \Sigma &\bnf& \ctxempty \bnfor \Sigma, n:A
  \end{array}
\]

\paragraph{Sorts.}

Sorts are kept abstract (as represented by the generic \cS) but are not
unrestricted. With the sorts should come the sort of a sort (or successor
sort) \(\succs{s}\), the sort of a \(\Pi\)-type \(\pisort{s_1}{s_2}\)
where \(s_1\) and \(s_2\) are the sorts of the domain and codomain respecitvely,
and likewise for each constructor.
These are functions, so the underlying \acrshort{PTS} is functional.
\todo{Define fun PTS}
Additionally, we ask that equality of sorts is decidable and that the successor
function is injective:
\[
  \succs{s_1} = \succs{s_2} \longrightarrow s_1 = s_2.
\]
Keeping the sorts abstract means that the proof can be instantiated with a lot
of different hierarchies, as long as they do not feature cumulativity
unfortunately. This will help us apply our result in the homotopy framework.

\paragraph{Annotations.}

Although it may look like a technical detail, the use of annotation is more
fundamental in \acrshort{ETT} than it is in \acrshort{ITT}/\acrshort{WTT}
where it is irrelevant and doesn't affect the theory.
This is actually one of the main differences between our work
(and that of Martin Hofmann~\sidecite{hofmann1995conservativity} who has a
similar presentation) and the work of Nicolas
Oury~\sidecite[0.7cm]{oury2005extensionality}.

Indeed, by using the standard model where types are interpreted as
cardinals rather than sets, it is possible to see that the equality
$\nat \to \nat = \nat \to \bool$ is independent from the theory, it is
thus possible to assume it (as an axiom, or for those that would still
not be convinced, simply under a $\lambda$ that would introduce this
equality).  In that context, the identity map $\lambda(x : \nat).\ x$
can be given the type $\nat \to \bool$ and we thus type
$(\lambda(x : \nat).\ x)\ \zero : \bool$.  Moreover, the
$\beta$-reduction of the non-annotated system used by Oury concludes
that this expression reduces to $\zero$, but cannot be given the type
$\bool$ (as we said, the equality $\nat \to \nat = \nat \to \bool$ is
independent from the theory, so the context is consistent). This means
we lack subject reduction in this case (or unique typing,
depending on how we see the issue).  Our presentation has a blocked
$\beta$-reduction limited to matching annotations:
$\app{(\lam{x:A}{B}\ t)}{x:A}{B}{u} = t[x \sto u]$, from which subject
reduction and unique typing follow.

\marginnote{
  \[
    \infer[JMAPP]
      {
        \Heq{\forall (x : U_1). V_1}{f_1}{\forall (x : U_2). V_2}{f_2} \\
        \Heq{U_1}{u_1}{U_2}{u_2}
      }
      {\Heq{V_1[x \sto u_1]}{f_1\ u_1}{V_2[x \sto u_2]}{f_2\ u_2}}
    %
  \]
}
Although subtle, this difference is responsible for Oury's need for an
extra axiom. Indeed, to treat the case of equality of applications in
his proof, he needs to assume the congruence rule for heterogeneous
equality of applications, which is not provable when formulated with
\acrshort{JMeq}. Thanks to annotations and our notion of heterogeneous equality,
we can prove this congruence rule for applications.
\todo{Maybe move this earlier? At least part of this discussion should already
be treated.}

\paragraph{Axioms.}

Another interesting bit is the presence of the \(\ax{n}\) term, as well as
that of the \(\Sigma\) context. Indeed, in order for our \acrshort{ETT} to be
a bit extensible, we add a context \(\Sigma\) of axioms \(n : A\) that can be
referenced using \(\ax{n}\) but cannot be bound (they are global).
For a theory like \Coq, having just axioms is bit weak, but in \acrshort{ETT}
this is enough to simulate constants and even things such as inductive types:
any computation rule can be stated propositionally and still be definitional
thanks to reflection.

For instance to simulate the constant
\[
  n : A \coloneqq t
\]
we can use the following context
\[
  n : A,\ n_{\mathit{def}} : n = t
\]

Similarly, booleans can de encoded as follows.
\marginnote[1cm]{
  Note that the sort \(s\) is fixed in the eliminator so it's still not that
  convenient, but it will serve for a few examples.
}
\[
  \begin{array}{lcl}
    B &:& s, \\
    t &:& B, \\
    f &:& B, \\
    \mathit{if} &:& \Pi (P : B \to s).\ P\ t \to P\ f \to \Pi (b : B).\ P\ b, \\
    \mathit{if_t} &:& \Pi P\ u\ v.\ \mathit{if}\ P\ u\ v\ t = u, \\
    \mathit{if_f} &:& \Pi P\ u\ v.\ \mathit{if}\ P\ u\ v\ f = v
  \end{array}
\]

\subsection{Syntax of \acrshort{ITT}}

\acrshort{ITT} is not really far from \acrshort{ETT}, we only extend the syntax
of terms with \acrshort{funext} and \acrshort{UIP}:

\[
  \begin{array}{l@{~\,}r@{~\,}l}
    T,A,B,t,u,v &\bnf& \dots \bnfor \funext{x:A}{B}{f}{g}{e} \bnfor
    \uip{A}{u}{v}{p}{q}
  \end{array}
\]

This does not really call for discussion, it all has been treated earlier.

\subsection{Syntax of \acrshort{WTT}}

\subsection{Can \acrshort{ETT} still be called a conservative extension?}

\todo{It doesn't really matter conservativity can still be stated with a simple
translation from ITT/WTT to ETT.}

\section{Typing rules}
\todo{Mention no cumulativity}