% \setchapterpreamble[u]{\margintoc}
\chapter{Framework}
\labch{elim-reflection-framework}

Now that the problem is stated, I will clearly define what the type theories
I will use as source and target. This is a bit redundant with \nrefch{flavours}
but I think it's worthwhile to make it clear what the translation is operating
on.

\section{Syntax(es)}
\labsec{trans-syntaxes}

To make things simple I will consider the syntax of \acrshort{ITT} and
\acrshort{WTT} as extensions of the syntax of \acrshort{ETT}.
Actually, \acrshort{WTT} will also extend \acrshort{ITT}.

\subsection{Syntax of \acrshort{ETT}}

First, comes the syntax of \acrshort{ETT}.

\[
  \begin{array}{l@{~\,}r@{~\,}l}
    s &\in& \cS \\
    T,A,B,t,u,v &\bnf& x \bnfor \lam{x:A}{B} t \bnfor \app{t}{x:A}{B}{u} \\
    &\bnfor& \pair{x:A}{B}{u}{v} \bnfor \pio{x:A}{B}{p} \bnfor \pit{x:A}{B}{p} \\
    &\bnfor& \refl{A} u \bnfor \J{A}{u}{x.e.P}{w}{v}{p} \\
    &\bnfor& \ax{n} \\
    &\bnfor& s \bnfor \Prod{x:A} B \bnfor \Sum{x:A} B \bnfor \Eq{A}{u}{v} \\
    \Ga, \D &\bnf& \ctxempty \bnfor \Ga, x:A \\
    \Sigma &\bnf& \ctxempty \bnfor \Sigma, n:A
  \end{array}
\]

\paragraph{Sorts.}

Sorts are kept abstract (as represented by the generic \cS) but are not
unrestricted. With the sorts should come the sort of a sort (or successor
sort) \(\succs{s}\), the sort of a \(\Pi\)-type \(\pisort{s_1}{s_2}\)
where \(s_1\) and \(s_2\) are the sorts of the domain and codomain respecitvely,
and likewise for each constructor.
These are functions, so the underlying \acrshort{PTS} is functional.
\todo{Define fun PTS}
Additionally, we ask that equality of sorts is decidable and that the successor
function is injective:
\[
  \succs{s_1} = \succs{s_2} \longrightarrow s_1 = s_2.
\]
Keeping the sorts abstract means that the proof can be instantiated with a lot
of different hierarchies, as long as they do not feature cumulativity
unfortunately. This will help us apply our result in the homotopy framework.

\paragraph{Annotations.}

Although it may look like a technical detail, the use of annotation is more
fundamental in \acrshort{ETT} than it is in \acrshort{ITT}/\acrshort{WTT}
where it is irrelevant and doesn't affect the theory.
This is actually one of the main differences between our work
(and that of Martin Hofmann~\sidecite{hofmann1995conservativity} who has a
similar presentation) and the work of Nicolas
Oury~\sidecite[0.7cm]{oury2005extensionality}.

Indeed, by using the standard model where types are interpreted as
cardinals rather than sets, it is possible to see that the equality
$\nat \to \nat = \nat \to \bool$ is independent from the theory, it is
thus possible to assume it (as an axiom, or for those that would still
not be convinced, simply under a $\lambda$ that would introduce this
equality).  In that context, the identity map $\lambda(x : \nat).\ x$
can be given the type $\nat \to \bool$ and we thus type
$(\lambda(x : \nat).\ x)\ \zero : \bool$.  Moreover, the
$\beta$-reduction of the non-annotated system used by Oury concludes
that this expression reduces to $\zero$, but cannot be given the type
$\bool$ (as we said, the equality $\nat \to \nat = \nat \to \bool$ is
independent from the theory, so the context is consistent). This means
we lack subject reduction in this case (or unique typing,
depending on how we see the issue).  Our presentation has a blocked
$\beta$-reduction limited to matching annotations:
$\app{(\lam{x:A}{B}\ t)}{x:A}{B}{u} = t[x \sto u]$, from which subject
reduction and unique typing follow.

\marginnote{
  \[
    \infer[JMAPP]
      {
        \Heq{\forall (x : U_1). V_1}{f_1}{\forall (x : U_2). V_2}{f_2} \\
        \Heq{U_1}{u_1}{U_2}{u_2}
      }
      {\Heq{V_1[x \sto u_1]}{f_1\ u_1}{V_2[x \sto u_2]}{f_2\ u_2}}
    %
  \]
}
Although subtle, this difference is responsible for Oury's need for an
extra axiom. Indeed, to treat the case of equality of applications in
his proof, he needs to assume the congruence rule for heterogeneous
equality of applications, which is not provable when formulated with
\acrshort{JMeq}. Thanks to annotations and our notion of heterogeneous equality,
we can prove this congruence rule for applications.
\todo{Maybe move this earlier? At least part of this discussion should already
be treated.}

\paragraph{Axioms.}

Another interesting bit is the presence of the \(\ax{n}\) term, as well as
that of the \(\Sigma\) context. Indeed, in order for our \acrshort{ETT} to be
a bit extensible, we add a context \(\Sigma\) of axioms \(n : A\) that can be
referenced using \(\ax{n}\) but cannot be bound (they are global).
For a theory like \Coq, having just axioms is bit weak, but in \acrshort{ETT}
this is enough to simulate constants and even things such as inductive types:
any computation rule can be stated propositionally and still be definitional
thanks to reflection.

For instance to simulate the constant
\[
  n : A \coloneqq t
\]
we can use the following context
\[
  n : A,\ n_{\mathit{def}} : n = t
\]

Similarly, booleans can de encoded as follows.
\marginnote[1cm]{
  Note that the sort \(s\) is fixed in the eliminator so it's still not that
  convenient, but it will serve for a few examples.
}
\[
  \begin{array}{lcl}
    B &:& s, \\
    t &:& B, \\
    f &:& B, \\
    \mathit{if} &:& \Pi (P : B \to s).\ P\ t \to P\ f \to \Pi (b : B).\ P\ b, \\
    \mathit{if_t} &:& \Pi P\ u\ v.\ \mathit{if}\ P\ u\ v\ t = u, \\
    \mathit{if_f} &:& \Pi P\ u\ v.\ \mathit{if}\ P\ u\ v\ f = v
  \end{array}
\]

\subsection{Syntax of \acrshort{ITT} and \acrshort{WTT}}

\acrshort{ITT} is not really far from \acrshort{ETT}, we only extend the syntax
of terms with \acrshort{funext} and \acrshort{UIP}:

\[
  \begin{array}{l@{~\,}r@{~\,}l}
    T,A,B,t,u,v &\bnf& \dots \bnfor \funext{x:A}{B}{f}{g}{e} \bnfor
    \uip{A}{u}{v}{p}{q}
  \end{array}
\]

We build \acrshort{WTT} over \acrshort{ITT} by adding computation rules
and some missing congruence rules (in the likeness of \acrshort{funext}).
Indeed the elimination of equality provided by \(\mathsf{J}\) or by Leibniz'
principle doesn't account for equalities under binders; conversion however does
and as such in \acrshort{WTT} we need to add this to the theory.
In \acrshort{ITT} it's enough to use the congruence of conversion and
\acrshort{funext} to recover all of those, unfortunately in \acrshort{WTT} I
could not yet find a way to factorise them. As such we add to the syntax
equality constructors for each binder.

\[
  \begin{array}{l@{~\,}r@{~\,}l}
    T,A,B,t,u,v &\bnf& \dots \bnfor \beta(t,u) \\
    &\bnfor& \lamb{x:A}{e_B} e_t
    \bnfor \appb{u}{x:A}{e_B}{v} \\
    &\bnfor& \pairb{x:A}{e_B}{u}{v}
    \bnfor \piob{x:A}{e_B}{p} \bnfor \pitb{x:A}{e_B}{p} \\
    &\bnfor& \pib (x:A). e_B \bnfor \sumb (x:A). e_B
  \end{array}
\]
\todo{One for J as well? I'd like to avoid it. J should not really be in ETT
anyway.}

\subsection{Can \acrshort{ETT} still be called a conservative extension?}

\reminder[-0.6cm]{Conservative extension}{
  An extension \(\cT_2\) of a type theory \(\cT_1\) is \emph{conservative} if
  for every judgement \(\vdash_2 t : A\) such that \(\vdash_1 A\)
  (\ie \(A\) is a type in \(\cT_1\)), there exists \(t'\) such that
  \(\vdash_1 t' : A\).
}
As I said earlier one of the goals is to show that \acrshort{ETT} is a
conservative extension of both \acrshort{ITT} and \acrshort{WTT}. However this
cannot stricly be the case if \acrshort{ETT} is not first an \emph{extension}
of those.

This is not really an issue because the terms we add to the syntax of
\acrshort{ITT} and \acrshort{WTT} can be encoded in \acrshort{ETT} as
definitions. The notion of conservativity can thus be adapted to work in that
case: let us write \(\iota\) the translation that is homorphically the identity
but replaces extra symbols like \acrshort{funext} and \acrshort{UIP} with their
respective proofs in \acrshort{ETT}, \acrshort{ETT} is conservative over
\acrshort{ITT}/\acrshort{WTT} in the sense that every \(\vdash A\) such that
\(\vdash_\exmark t : \iota(A)\) there exists a term \(t'\) such that
\(\vdash t' : A\).

\todo{It doesn't really matter conservativity can still be stated with a simple
translation from ITT/WTT to ETT.}

\section{Typing rules}
\todo{Mention no cumulativity}

Similarly to the syntax I will present first the common rules of all involved
theories and then detail the specificities of each.

\subsection{Common typing rules}

For all systems, the typing rules are the same for the most part. Conversion and
the conversion rule will be the main point of divergence, besides the new
terms in \acrshort{ITT} and \acrshort{WTT} of course.

\paradot{Well-formedness of contexts}

\begin{mathpar}
  \infer[]
    { }
    {\isctx{\ctxempty}}
  %

  \infer[]
    {\isctx{\Ga} \\
      \istype{\Ga}{A}
    }
    {\isctx{\Ga, x:A}}
  (x \notin \Ga)
\end{mathpar}

\paradot{Types}

\marginnote[1cm]{
  The sort constructors here are those mentioned in \nrefsec{trans-syntaxes},
  though not all were given explicit names.
}
\begin{mathpar}
  \infer[]
    {\isctx{\Ga}}
    {\isterm{\Ga}{s}{\succs{s}}}
  %

  \infer[]
    {\isterm{\Ga}{A}{s_1} \\
      \isterm{\Ga,x:A}{B}{s_2}
    }
    {\isterm{\Ga}{\Prod{x:A} B}{\pisort{s_1}{s_2}}}
  %

  \infer[]
    {\isterm{\Ga}{A}{s_1} \\
      \isterm{\Ga,x:A}{B}{s_2}
    }
    {\isterm{\Ga}{\Sum{x:A} B}{\sumsort{s_1}{s_2}}}
  (s,s',s'')

  \infer[]
    {\isterm{\Ga}{A}{s} \\
      \isterm{\Ga}{u}{A} \\
      \isterm{\Ga}{v}{A}
    }
    {\isterm{\Ga}{\Eq{A}{u}{v}}{\eqsort{s}}}
  %
\end{mathpar}

\paradot{$\lambda$-calculus terms}

\begin{mathpar}
  \infer[]
    {\isctx{\Ga} \\
      (x : A) \in \Ga
    }
    {\isterm{\Ga}{x}{A}}
  %

  \infer[]
    {\isterm{\Ga}{A}{s} \\
      \isterm{\Ga,x:A}{B}{s'} \\
      \isterm{\Ga,x:A}{t}{B}
    }
    {\isterm{\Ga}{\lam{x:A}{B} t}{\Prod{x:A} B}}
  %

  \infer[]
    {\isterm{\Ga}{A}{s} \\
      \isterm{\Ga,x:A}{B}{s'} \\
      \isterm{\Ga}{t}{\Prod{x:A} B} \\
      \isterm{\Ga}{u}{A}
    }
    {\isterm{\Ga}{\app{t}{x:A}{B}{u}}{B[x \sto u]}}
  %

  \infer[]
    {\isterm{\Ga}{u}{A} \\
      \isterm{\Ga}{A}{s} \\
      \isterm{\Ga,x:A}{B}{s'} \\
      \isterm{\Ga}{v}{B[x \sto u]}
    }
    {\isterm{\Ga}{\pair{x:A}{B}{u}{v}}{\Sum{x:A}{B}}}
  %

  \infer[]
    {\isterm{\Ga}{p}{\Sum{x:A}{B}}}
    {\isterm{\Ga}{\pio{x:A}{B}{p}}{A}}
  %

  \infer[]
    {\isterm{\Ga}{p}{\Sum{x:A}{B}}}
    {\isterm{\Ga}{\pit{x:A}{B}{p}}{B[x \sto \pio{x:A}{B}{p}]}}
  %
\end{mathpar}

\paradot{Equality terms}

\begin{mathpar}
  \infer[]
    {\isterm{\Ga}{A}{s} \\
      \isterm{\Ga}{u}{A}
    }
    {\isterm{\Ga}{\refl{A} u}{\Eq{A}{u}{u}}}
  %

  \infer[]
    {\isterm{\Ga}{A}{s} \\
      \isterm{\Ga}{u,v}{A} \\
      \isterm{\Ga, x:A, e:\Eq{A}{u}{x}}{P}{s'} \\
      \isterm{\Ga}{p}{\Eq{A}{u}{v}} \\
      \isterm{\Ga}{w}{P[x \sto u, e \sto \refl{A} u]}
    }
    {\isterm
      {\Ga}
      {\J{A}{u}{x.e.P}{w}{v}{p}}
      {P[x \sto v, e \sto p]}
    }
  %
\end{mathpar}

% \begin{mathpar}
%   \infer[]
%     {\isterm{\Ga}{u}{A} \\
%       \eqtype{\Ga}{A}{B} : s
%     }
%     {\isterm{\Ga}{u}{B}}
%   %

%   \infer[]
%     {\isterm{\Ga}{e_1,e_2}{\Eq{A}{u}{v}}}
%     {\isterm{\Ga}{\uip{A}{u}{v}{e_1}{e_2}}{\Eq{}{e_1}{e_2}}}
%   %

%   \infer[]
%     {\isterm{\Ga}{f,g}{\Prod{x:A} B} \\
%       \isterm
%         {\Ga}
%         {e}
%         {\Prod{x:A} \Eq{B}{\app{f}{x:A}{B}{x}}{\app{g}{x:A}{B}{x}}}
%     }
%     {\isterm{\Ga}{\funext{x:A}{B}{f}{g}{e}}{\Eq{}{f}{g}}}
%   %
% \end{mathpar}