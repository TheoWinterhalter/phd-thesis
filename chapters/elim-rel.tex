% \setchapterpreamble[u]{\margintoc}
\chapter{Relating translated expressions}
\labch{elim-rel}

We want to define a relation on terms that equates two terms that are
the same up to transport.
%
This begs the question of what notion of transport is going to be
used.
%
Transport can be defined from elimination of equality as in \vrefch{usual-defs}.
However, in order not to confuse the transports added by the
translation with the transports that were already present in the
source, we consider $\transpo{p}$ as part of the syntax in the
reasoning. It will be unfolded to its definition only after the
complete translation is performed.
%
This idea is not novel as Hofmann already had a $\mathsf{Subst}$ operator that
was part of his \acrshort{ITT} (noted TT\textsubscript{I} in his
paper~\sidecite{hofmann1995conservativity}).

\section{Relating terms and their translation}

We first define the (purely syntactic) relation $\ir$ between \acrshort{ETT}
terms and target terms by saying the translated term must be a decoration of the
first term by transports.
Its purpose is to state how close to the original term its translation is.
In the definition, the most important rule is highlighted.

\begin{mathpar}

  \highlight{
    \infer[]
      {t_1 \ir t_2}
      {t_1 \ir \transpo{p}\ t_2}
    %
  }

  \\
  \infer[]
    { }
    {x \ir x}
  %

  \infer[]
    {A_1 \ir A_2 \\
     B_1 \ir B_2
    }
    {\Prod{x:A_1} B_1 \ir \Prod{x:A_2} B_2}
  %

  \infer[]
    {A_1 \ir A_2 \\
     B_1 \ir B_2
    }
    {\Sum{x:A_1} B_1 \ir \Sum{x:A_2} B_2}
  %

  \infer[]
    {A_1 \ir A_2 \\
     u_1 \ir u_2 \\
     v_1 \ir v_2
    }
    {\Eq{A_1}{u_1}{v_1} \ir \Eq{A_2}{u_2}{v_2}}
  %

  \infer[]
    { }
    {s \ir s}
  %

  \infer[]
    {A_1 \ir A_2 \\
     B_1 \ir B_2 \\
     t_1 \ir t_2
    }
    {\lam{x:A_1}{B_1} t_1 \ir \lam{x:A_2}{B_2} t_2}
  %

  \infer[]
    {t_1 \ir t_2 \\
     A_1 \ir A_2 \\
     B_1 \ir B_2 \\
     u_1 \ir u_2
    }
    {\app{t_1}{x:A_1}{B_1}{u_1} \ir \app{t_2}{x:A_2}{B_2}{u_2}}
  %

  \infer[]
    {A_1 \ir A_2 \\
     B_1 \ir B_2 \\
     t_1 \ir t_2 \\
     u_1 \ir u_2
    }
    {\pair{x:A_1}{B_1}{t_1}{u_1} \ir \pair{x:A_2}{B_2}{t_2}{u_2}}
  %

  \infer[]
    {A_1 \ir A_2 \\
     B_1 \ir B_2 \\
     p_1 \ir p_2
    }
    {\pio{x:A_1}{B_1}{p_1} \ir \pio{x:A_2}{B_1}{p_2}}
  %

  \infer[]
    {A_1 \ir A_2 \\
     B_1 \ir B_2 \\
     p_1 \ir p_2
    }
    {\pit{x:A_1}{B_1}{p_1} \ir \pit{x:A_2}{B_2}{p_2}}
  %

  \infer[]
    {A_1 \ir A_2 \\
     u_1 \ir u_2
    }
    {\refl{A_1} u_1 \ir \refl{A_2} u_2}
  %
\end{mathpar}

From this relation we build a new one \(\sim\)) between translated terms.
\(u \sim v\) basically means that \(u\) and \(v\) are both decorations of the
same term.

\[
  \sim\ \coloneqq\ \sqsupset^+ . \ir^+
\]

In order to better reason about it however, we actually define it inductively
again.

\begin{mathpar}
  \highlight{
    \infer[]
      {t_1 \sim t_2}
      {\transpo{p}\ t_1 \sim t_2}
    %
  }

  \highlight{
    \infer[]
      {t_1 \sim t_2}
      {t_1 \sim \transpo{p}\ t_2}
    %
  }

  \infer[]
    {A_1 \sim A_2 \\
     B_1 \sim B_2
    }
    {\Prod{x:A_1} B_1 \sim \Prod{x:A_2} B_2}
  %

  \infer[]
    {A_1 \sim A_2 \\
     B_1 \sim B_2
    }
    {\Sum{x:A_1} B_1 \sim \Sum{x:A_2} B_2}
  %

  \infer[]
    {A_1 \sim A_2 \\
     u_1 \sim u_2 \\
     v_1 \sim v_2
    }
    {\Eq{A_1}{u_1}{v_1} \sim \Eq{A_2}{u_2}{v_2}}
  %

  \infer[]
    { }
    {s \sim s}
  %

  \infer[]
    {A_1 \sim A_2 \\
     B_1 \sim B_2 \\
     t_1 \sim t_2
    }
    {\lam{x:A_1}{B_1} t_1 \sim \lam{x:A_2}{B_2} t_2}
  %

  \infer[]
    {t_1 \sim t_2 \\
     A_1 \sim A_2 \\
     B_1 \sim B_2 \\
     u_1 \sim u_2
    }
    {\app{t_1}{x:A_1}{B_1}{u_1} \sim \app{t_2}{x:A_2}{B_2}{u_2}}
  %

  \infer[]
    {A_1 \sim A_2 \\
     B_1 \sim B_2 \\
     t_1 \sim t_2 \\
     u_1 \sim u_2
    }
    {\pair{x:A_1}{B_1}{t_1}{u_1} \sim \pair{x:A_2}{B_2}{t_2}{u_2}}
  %

  \infer[]
    {A_1 \sim A_2 \\
     B_1 \sim B_2 \\
     p_1 \sim p_2
    }
    {\pio{x:A_1}{B_1}{p_1} \sim \pio{x:A_2}{B_1}{p_2}}
  %

  \infer[]
    {A_1 \sim A_2 \\
     B_1 \sim B_2 \\
     p_1 \sim p_2
    }
    {\pit{x:A_1}{B_1}{p_1} \sim \pit{x:A_2}{B_2}{p_2}}
  %

  \infer[]
    {A_1 \sim A_2 \\
     u_1 \sim u_2
    }
    {\refl{A_1} u_1 \sim \refl{A_2} u_2}
  %
\end{mathpar}

\section{Properties of the relation}

\begin{lemma}[$\sim$ is a partial equivalence relation]
  \label{lem:sim-er}
  $\sim$ is symmetric and transitive.
\end{lemma}

% \begin{proof}
%   For reflexivity we proceed by induction on the term.
% \end{proof}

The goal is to prove that two terms in this relation, that are well-typed in the
target type theory, are heterogeneously equal.

\todo{Properties on heterogeneous equality should have their own section.}
This definition of heterogeneous equality can be shown to be
reflexive, symmetric and transitive. Because of UIP, heterogeneous
equality collapses to equality when taken on the same type.

\begin{lemma}
  \label{lem:uip-cong}
  If $\isterm{\Ga}{e}{\Heq{A}{u}{A}{v}}$
  then there exists $p$ such that $\isterm{\Ga}{p}{\Eq{A}{u}{v}}$.
\end{lemma}

\begin{proof}
  This holds thanks to UIP on equality, which implies K, and so the
  proof of $A = A$ can be taken to be reflexivity.
\end{proof}

\begin{remark}
  As a corollary, $\Heqs$ on types corresponds to equality.
  Indeed when we have $\isterm{\Ga}{e}{\Heq{s}{A}{s'}{B}}$ we have
  that $\Eq{}{s}{s'}$, which implies that $s$ and $s'$ have the same sort
  and thus are syntactically the same (by an inversion argument).
\end{remark}

Before we can prove the fundamental lemma stating that two terms in relation
are heterogeneously equal, we need to consider another construction.
%
As explained in the introduction, when proving the property by
induction on terms, we introduce variables in the context that are
equal only up-to heterogeneous equality.
%
This phenomenon is similar to what happens in the parametricity
translation~\sidecite{bernardy2012proofs}.
%
Our fundamental lemma on the decoration relation $\sim$ assumes two
related terms of potentially different types $T1$ and $T2$ to produce an
heterogeneous equality between them. For induction to go through under
binders (e.g. for dependent products and abstractions), we hence need to
consider the two terms under different, but heterogeneously equal
contexts.
%
Therefore, the context we produce will not only be a telescope of
variables, but rather a telescope of triples consisting of two variables
of possibly different types, and a witness that they are heterogeneously
equal.
%
To make this precise, we define the following macro:
%
\[
\Pack{A_1}{A_2} := \Sum{x:A_1} \Sum{y:A_2} \Heq{}{x}{}{y}
\]
together with its projections
\begin{mathpar}
  \ProjO{p} := \pio{}{}{p}

  \ProjT{p} := \pio{}{}{\pit{}{}{p}}

  \ProjE{p} := \pit{}{}{\pit{}{}{p}}.
\end{mathpar}
%
We can then extend this notion canonically to contexts of the same
length that are well formed using the same sorts:
%
\[
\begin{array}{l}
    \Pack{(\Ga_1, x:A_1)}{(\Ga_2, x:A_2)} := \\
    (\Pack{\Ga_1}{\Ga_2}),
    x : \Pack{(\llift{\gamma}{}{A_1})}{(\rlift{\gamma}{}{A_2})} \\
    \\
    \Pack{\ctxempty}{\ctxempty} := \ctxempty.
\end{array}
\]
%
When we pack contexts, we also need to apply the correct projections for
the types in that context to still make sense. Assuming two contexts
$\Ga_1$ and $\Ga_2$ of the same length, we can define left and right
substitutions:
\[
\begin{array}{ll}
  \gamma_1 &:= [ x \leftarrow \ProjO{x}\ |\ (x : \_) \in \Ga_1 ] \\
  \gamma_2 &:= [ x \leftarrow \ProjT{x}\ |\ (x : \_) \in \Ga_2 ].
\end{array}
\]
These substitutions implement lifting of terms to packed contexts:
$\isterm{\Ga, \Pack{\Ga_1}{\Ga_2}}{\llift{\gamma}{}{t}}{\llift{\gamma}{}{A}}$
whenever $\isterm{\Ga, \Ga_1}{t}{A}$ (resp.
$\isterm{\Ga, \Pack{\Ga_1}{\Ga_2}}{\rlift{\gamma}{}{t}}{\rlift{\gamma}{}{A}}$
whenever $\isterm{\Ga, \Ga_2}{t}{A}$).

For readability, when $\Ga_1$ and $\Ga_2$ are understood we will write $\Gp$ for
$\Pack{\Ga_1}{\Ga_2}$.

Implicitly, whenever we use the notation $\Pack{\Ga_1}{\Ga_2}$ it means that
the two contexts are of the same length and well-formed with the same
sorts.
%
We can now state the fundamental lemma.

\begin{lemma}[Fundamental lemma]
  \label{lem:sim-cong}
  Let $t_1$ and $t_2$ be two terms. If $\isterm{\Ga, \Ga_1}{t_1}{T_1}$ and
  $\isterm{\Ga, \Ga_2}{t_2}{T_2}$ and $t_1 \sim t_2$ then there exists $p$ such
  that
  $\isterm{\Ga, \Pack{\Ga_1}{\Ga_2}}
          {p}
          {\Heq{\llift{\gamma}{}{T_1}}
               {\llift{\gamma}{}{t_1}}
               {\rlift{\gamma}{}{T_2}}
               {\rlift{\gamma}{}{t_2}}}$.
\end{lemma}

\begin{proof}
  The proof is by induction on the derivation of $t_1 \sim t_2$. We show
  the three most interesting cases:

  \begin{itemize}
  \item \textsc{Var}
    \[
      \infer[]
        { }
        {x \sim x}
      %
    \]
    If $x$ belongs to $\Ga$, we apply reflexivity---together with uniqueness of
    typing~\eqref{lem:uniq}---to conclude.
    Otherwise, $\ProjE{x}$ has the expected type (since
    $\llift{\gamma}{}{x} \equiv \ProjO{x}$ and $\rlift{\gamma}{}{x} \equiv \ProjT{x}$).

  \item \textsc{Application}
    \[
      \infer[]
        {t_1 \sim t_2 \\
         A_1 \sim A_2 \\
         B_1 \sim B_2 \\
         u_1 \sim u_2
        }
        {\app{t_1}{x:A_1}{B_1}{u_1} \sim \app{t_2}{x:A_2}{B_2}{u_2}}
      %
    \]
    We have $\isterm{\Ga, \Ga_1}{\app{t_1}{x:A_1}{B_1}{u_1}}{T_1}$ and
    $\isterm{\Ga, \Ga_2}{\app{t_2}{x:A_2}{B_2}{u_2}}{T_2}$ which means by
    inversion~\eqref{lem:inversion} that the subterms are well-typed.
    We apply the induction hypothesis and then conclude.
  \item \textsc{TransportLeft}
    \[
      \infer[]
        {t_1 \sim t_2}
        {\transpo{p}\ t_1 \sim t_2}
      %
    \]
    We have $\isterm{\Ga, \Ga_1}{\transpo{p}\ t_1}{T_1}$ and
    $\isterm{\Ga, \Ga_2}{t_2}{T_2}$.
    By inversion~\eqref{lem:inversion} we have
    $\isterm{\Ga, \Ga_1}{p}{\Eq{}{T_1'}{T_1}}$ and
    $\isterm{\Ga, \Ga_1}{t_1}{T_1'}$.
    By induction hypothesis we have $e$ such that
    $\isterm{\Ga, \Gp}{e}{\Heq{}{\llift{\gamma}{}{t_1}}{}{\rlift{\gamma}{}{t_2}}}$.
    From transitivity and symmetry we only need to provide a proof of
    $\Heq{}{\llift{\gamma}{}{t_1}}{}{\transpo{\llift{\gamma}{}{p}}\ \llift{\gamma}{}{t_1}}$ which is inhabited by
    $\pair{\_}{\_}{\llift{\gamma}{}{p}}{\refl{} (\transpo{\llift{\gamma}{}{p}}\ \llift{\gamma}{}{t_1})}$.
  \end{itemize}

  The complete proof can be found in Appendix~\ref{sec:proof-fund-lemma}.
\end{proof}

We can also prove that $\sim$ preserves substitution.

\begin{lemma}
  If $t_1 \sim t_2$ and $u_1 \sim u_2$ then
  $t_1[x \sto u_1] \sim t_2[x \sto u_2]$.
\end{lemma}

\begin{proof}
  We proceed by induction on the derivation of $t_1 \sim t_2$.
\end{proof}