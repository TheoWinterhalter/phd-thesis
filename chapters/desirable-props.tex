% \setchapterpreamble[u]{\margintoc}
\chapter{Desirable properties of type theories}
\labch{desirable-props}

To compare different type theories there are several measures we can use in
form of usual or desirable properties that they migh satisfy or not.
After a brief presentation of the main ones I will summarise which of the
theories of \nrefch{flavours} has which properties in a table.

\section{Properties}

\subsection{Weakening and substitutivity}
\labsubsec{weak-subst}

Variables and binders are essential to type theory and as such we have to treat
them with care, in particular we want our theories to be \emph{compositional}
meaning that different blocks that make sense can be assembled into something
that still makes sense.
This is embodied in the two following properties.

\begin{definition}[Weakening]
  A type theory enjoys weakening when for any \(\Ga, \Xi \vdash t : A\) and
  \(\vdash \Ga, \Delta\) we have \(\Ga, \Delta, \Xi \vdash t : A\).
\end{definition}
\marginnote[-1.2cm]{
  Note that in more generality you might have to rename variables when
  weakening, so for this we usually introduce a \emph{lifting} operator
  \(\lift{}{}\) such that we have
  \(\Ga, \Delta, \Xi \vdash \lift{n}{k}\ t : \lift{n}{k}\ A\)
  where \(n = |\Delta|\) and \(k = |\Xi|\).
}

Weakening means that you can plug a term into a larger context.

Susbstitutions are the way to instantiate the variables that are bound.
This happens for instance after a \(\beta\)-reduction.
\reminder[-0.9cm]{\(\beta\)-reduction}{
  \[
    (\lambda (x:A). t)\ u \red_\beta t[x \sto u]
  \]
}
Substitutions are typed using two contexts: \(\sigma : \Ga \to \D\) basically
states that \(\sigma\) maps variables of \(\D\) to terms typed in \(\Ga\).
\begin{mathpar}
  \infer
    {\forall (x : A) \in \D,\ \Ga \vdash \sigma(x) : A\sigma}
    {\sigma : \Ga \to \D}
\end{mathpar}
This is sometimes written \(\Ga \vdash \sigma : \D\) instead, and typing
definitons vary a little depending on the definition of substitution but this
is the basic idea.

\begin{definition}[Substitutivity]
  A type theory is substitutive when for any \(\D \vdash t : A\)
  and any substitution \(\sigma : \Ga \to \D\), we have
  \(\Ga \vdash t\sigma : A\sigma\).
\end{definition}

More often than not, weakening and substitutivity also hold for reduction and
conversion.

\subsection{Inversion of typing}

Inversion of typing is not really a measure as it is always present in some way.
It is nonetheless a very useful property to state when reasoning on a type
theory.
It is saying than when we have \(\Ga \vdash t : A\), by analysing the shape of
\(t\) we can get information on \(A\) (and sometimes even \(\Ga\)).

\reminder[-0.6cm]{Application rule}{
  \[
    \infer
      {
        \Ga \vdash \Pi (x:A).\ B : s \\
        \Ga \vdash t : \Pi (x:A).\ B \\
        \Ga \vdash u : A
      }
      {\Ga \vdash t\ u : B[x \sto u]}
  \]
}
For instance, if we have \(\Ga \vdash t\ u : T\), then by inversion of typing
we know that there must exist \(A\) and \(B\) such that
\begin{mathpar}
  \Ga \vdash \Pi (x:A).\ B : s

  \Ga \vdash t : \Pi (x:A).\ B

  \Ga \vdash u : A

  \Ga \vdash T \equiv B[x \sto u]
\end{mathpar}

This can be proved by seeing that only two typing rules can be concluded with
\(\Ga \vdash t\ u : T\): the application rule and the conversion rule. The
result follows from a simple induction.

\marginnote[0.1cm]{
  Sometimes it will be talking about cumulativity \(\cumul\) instead of
  conversion \(\equiv\): in that case we would have
  \(\Ga \vdash B[x \sto u] \cumul T\) (we have to apply the application rule
  first and then possibly several time the cumulativity rule).
}
Now, it won't always be stated this way depending on the premises of the
application rule, but also depending on the presence or not of a conversion
rule. In the case of \acrshort{WTT} for instance, there is no conversion so
instead of \(\Ga \vdash T \equiv B[x \sto u]\) we will have syntactic equality
\(T =_{\alpha} B[x \sto u]\).

You usually prove inversion of typing for every term constructor, but I won't
do it here.

\subsection{Validity}

The term \emph{validity} might be a bit overloaded, and maybe not the norm
when it comes to type theory, but I will use it to be consistent with the
notion for \Coq.
This property states that the type on the right-hand side of the colon is indeed
a type.

\begin{definition}[Validity]
  A type theory enjoys validity when from \(\Ga \vdash t : A\) one can deduce
  \(\Ga \vdash A\) (\ie \(\Ga \vdash A : s\) for some sort \(s\)).
\end{definition}

Depending on the theory, we can often prove a similar property regarding
contexts: namely that \(\Ga \vdash t : A\) implies that \(\Ga\) is well-formed
(\(\vdash \Ga\)). Having this property mainly depends on whether the typing
rules of things like sorts and variables ask for the context to be well-formed.
%
\begin{mathpar}
  \infer
    {(x : A) \in \Ga}
    {\Ga \vdash x : A}
  %

  \text{vs}

  \infer
    {
      \vdash \Ga \\
      (x : A) \in \Ga
    }
    {\Ga \vdash x : A}
  %
\end{mathpar}
%
In a theory which does not have this requirement / property, many lemmata will
only apply assuming the contexts involved are well-formed.
The difference of presentation like this will be studied in
\nrefch{formalisation}.

\subsection{Unique / principal typing}

Unique typing is a property saying that each term (given a context) has only one
type up to conversion.

\begin{definition}[Unique typing]
  A type theory enjoys unique typing when
  \(\Ga \vdash t : A\) and \(\Ga \vdash t : B\) imply \(\Ga \vdash A \equiv B\).
\end{definition}

This usually means that the term is carrying enough information to recover
its type. If one were to use Curry-style terms~\misref{} like
\(\lambda x.\ x\) then this property can't hold: indeed
\(\vdash \lambda x.\ x : \unit \to \unit\) and
\(\vdash \lambda x.\ x : \bool \to \bool\) both hold and the two arrow types
are not related.

This property can be broken for other reasons however: the presence of subtyping
(typically cumulativity). In such a case, unique typing can be relaxed to
principal typing.

\begin{definition}[(Weak) principal typing]
  A type theory enjoys principal typing (in the weaker sense) when
  \(\Ga \vdash t : A\) and \(\Ga \vdash t : B\) imply \(\Ga \vdash t : C\) with
  \(\Ga \vdash C \cumul A\) and \(\Ga \vdash C \cumul B\).
\end{definition}

It might be perhaps more often understood in a stronger sense.

\begin{definition}[(Strong) principal typing]
  A type theory enjoys principal typing (in the stronger sense) when for every
  well typed term \(t\) in \(\Ga\), there exists a type \(P\) such that
  \(\Ga \vdash t : P\) and that whenever \(\Ga \vdash t : A\) we have
  \(\Ga \vdash P \cumul A\).
  \(P\) is called a principal type of \(t\) (in \(\Ga\)).
\end{definition}

The idea is that the principal type is the most general type that can be given
to a term.

\subsection{Properties of reduction}

When the type theory features reduction, we also want it to satisfy some
requirements, aside that reduction behaves in a compositional way as I already
explained in \nrefsubsec{weak-subst}.

First are basic properties of rewriting systems\sidenote{I won't go into details
about what they are and it's not necessary to know about them to understand any
of this.}: confluence and termination.

\sidedef[-0.4cm]{}{
  The transitive reflexive closure of reduction, written \(\reds\),
  is defined (inductively) by the rules
  \[
    \infer
      { }
      {t \reds t}
    %
  \]
  \[
    \infer
      {
        t \red u \\
        u \reds v
      }
      {t \reds v}
    %
  \]
}
\begin{definition}[Confluence]
  The reduction relation \(\red\) is confluent if for every \(t\) such that
  \(t \reds u\) and \(t \reds v\) there exists \(w\) such that \(u \reds w\)
  and \(v \reds w\).
\end{definition}

\begin{definition}[Weak normalisation]
  Weak normalisation of reduction means that for every well-typed term \(t\)
  there exists a term \(n\) such that \(t \reds n \not\red\).
  \(n\) is called a \emph{normal form} of \(t\).
\end{definition}

\begin{definition}[Strong normalisation]
  Strong normalisation, or termination, of reduction means that for every
  well-typed term \(t\), there is no infinite reduction sequence starting from
  \(t\).
\end{definition}

When a system is confluent and terminating, there exists exactly one normal form
for each well-typed term.

These properties are related to typing in that they require the term to be
well-typed in order to be applicable. That's because it's too easy to break
termination with non-sensical terms.
There is however a reduction property that is much more linked to typing:
subject reduction, sometimes called type safety or type preservation.

\begin{definition}[Subject reduction]
  A type theory enjoys subject reduction when for every \(\Ga \vdash t : A\)
  and \(t \red u\), we also have \(\Ga \vdash u : A\).
\end{definition}

This means simplifying a proof does not break its status of proof. This is a
very sensible property to have in a programming language or a proof assistant.
It's absence is usually a sign that something is very wrong with the considered
system: if evaluation might break things, why have evaluation at all?

\subsection{Canonicity}
\todo{With reduction or weaker with conversion (for ETT)}

\subsection{Decidability of type checking}

\subsection{Consistency}

\section{Summarising table}

\todo{Fill}
\begin{table*}
  \rowcolors{1}{SkyBlue!10!White}{}
  \caption[Properties of type theories]{Properties of type theories.}
  \begin{tabular}{l|c|c|c|c|c|c|c|c|c|}
    \cline{2-10}
    & \acrshort{WTT} & \acrshort{ITT} & \acrshort{ETT} & \acrshort{MLTT}
    & \acrshort{PCUIC} & ?HoTT & ?CubicalTT & ?2TT & ?HTS \\
    \hline
    \multicolumn{1}{ |c|  }{Weakening / substitutivity} &
    \multicolumn{9}{c|}{Yes} \\
    \hline
    \multicolumn{1}{ |c|  }{Inversion of typing} &
    \multicolumn{9}{c|}{Yes} \\
    \hline
    \multicolumn{1}{ |c|  }{Unique (U) / Principal type (P)} &
    U & U/P & No? & U & P & ? & ? & ? & ? \\
    \hline
  \end{tabular}
\end{table*}